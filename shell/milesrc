# If not running interactively, don't do anything
[[ $- == *i* ]] || return

# The magic happens in this file.

# {{{ Helper utils
function installed() {
    type -a $1 2>&1 | grep -m 1 -oPs "$1 is \K/.+"
}

function join_with() { local IFS="$1"; echo "${*:2}"; }

export MILESRC_SHELL="$(installed zsh)"
[[ -z $BASH ]] || export MILESRC_SHELL="$BASH"
# }}}

# {{{ User configs
# Local stuff
[[ ! -f $HOME/.milesrc.pre ]] || . $HOME/.milesrc.pre
if [[ -z $TMUX ]] && [[ -n $MILESRC_TMUX ]]; then
    exec tmux -2 new -A -s main
fi
. $HOME/.milesrc/shell/milesrc.ssh_agent
# }}}

case "$MILESRC_SHELL" in
    *"bash")
        # {{{ Bash setup
        # export BASHV="$(bash --version | grep -m 1 -oPs "\d+\.\d+")"

        # History settings
        export HISTFILE="$HOME/.histfile.bash"
        export HISTSIZE="1000"
        export HISTFILESIZE="2000"
        export HISTCONTROL="ignoreboth"
        shopt -s histappend histverify

        # Don't need to type cd
        shopt -s autocd

        # Fix common typos when cd'ing
        shopt -s cdspell
        shopt -s dirspell

        # Multi-line command history
        shopt -s cmdhist

        # Enable programmable completion features (you don't need to
        # enable this, if it's already enabled in /etc/bash.bashrc and
        # /etc/profile sources /etc/bash.bashrc).
        # Don't use [] around shopt command
        if [[ -f /etc/bash_completion ]] && ! shopt -oq posix; then
            . /etc/bash_completion
        fi

        # Super globs
        shopt -s globstar extglob nocasematch

        # Check the window size after each command and, if necessary,
        # update the values of LINES and COLUMNS.
        shopt -s checkwinsize

        if [[ -n $MILESRC_VI_BINDINGS ]]; then
            # vi keybindings
            set -o vi

            # Bind jk/kj to escape or vi-movement-mode
            bind -m vi-insert '"jk":vi-movement-mode'
            bind -m vi-insert '"kj":vi-movement-mode'

            # Fix some vi keybindings
            bind '"^?":backward-delete-char'
            bind '"^H":backward-delete-char'
            bind '"":clear-screen'
            bind '"^U":kill-line'
            bind '"^W":backward-kill-word'

            if [[ -n $(bind -P | grep -s "history-substring-searc") ]]
            then
                bind -m vi-move \
                    '"k":history-substring-search-backward'
                bind -m vi-move '"j":history-substring-search-forward'
            else
                bind -m vi-move '"k":history-search-backward'
                bind -m vi-move '"j":history-search-forward'
            fi
        fi

        # Fix ^S
        [[ -z $(installed stty) ]] || stty stop ""
        # }}}
        ;;
    *"zsh")
        # {{{ Zsh setup
        export ZSHV="$(zsh --version | grep -m 1 -oPs "\d+\.\d+")"

        # History settings
        export HISTFILE="$HOME/.histfile.zsh"
        export HISTSIZE="1000"
        export SAVEHIST="$HISTSIZE"
        setopt incappendhistory histexpiredupsfirst histignorealldups
        setopt histreduceblanks sharehistory

        # Completion style
        zstyle ":completion:*" menu select
        zstyle ":completion:*" rehash true
        zstyle ":completion:*" verbose yes
        zstyle ":completion:*:descriptions" format "%B%d%b"
        zstyle ":completion:*:messages" format "%d"
        zstyle ":completion:*:warnings" format "No matches for: %d"
        zstyle ":completion:*:corrections" format "%B%d (err: %e)%b"
        zstyle ":completion:*" group-name ""
        # Tab completion should be case-insensitive
        zstyle ":completion:*" matcher-list "m:{a-zA-Z}={A-Za-z}"
        # Better completion for killall
        zstyle ":completion:*:killall:*" command \
            "ps -ocomm -u $USER | grep -sv \"COMMAND\""

        zstyle :compinstall filename "$HOME/.zshrc"

        # Don't need to type cd
        setopt autocd notify

        # Don't beep
        unsetopt beep
        setopt nobeep

        # Make cd push the old directory onto the stack
        setopt autopushd

        if [[ -n $MILESRC_VI_BINDINGS ]]; then
            # vi keybindings
            bindkey -v

            # Bind jk/kj to escape
            bindkey -M viins "jk" vi-cmd-mode
            bindkey -M viins "kj" vi-cmd-mode

            # Fix some vi keybindings
            bindkey "^?" backward-delete-char
            bindkey "^H" backward-delete-char
            bindkey "^L" clear-screen
            bindkey "^U" kill-line
            bindkey "^W" backward-kill-word
        fi

        # Turn off terminal driver flow control (CTRL+S/CTRL+Q)
        setopt noflowcontrol
        [[ -z $(installed stty) ]] || stty -ixon -ixoff

        # Do not kill background processes when closing the shell
        setopt nohup

        # Tab completion enhancements
        setopt automenu
        unsetopt menucomplete
        setopt completealiases

        # Tab completion from anywhere in word
        setopt completeinword

        # Change the definition of "word", e.g. with ^W
        autoload select-word-style
        select-word-style shell

        # Super globs
        setopt extendedglob
        unsetopt caseglob

        # Pound sign in interactive prompt
        setopt interactivecomments

        # Speed up file completion for git
        function __git_files() {
            _wanted files expl "local files" _files
        }

        # Syntax highlighting
        typeset -A ZSH_HIGHLIGHT_STYLES
        ZSH_HIGHLIGHT_STYLES[unknown-token]="fg=red"
        ZSH_HIGHLIGHT_STYLES[alias]="fg=white"
        ZSH_HIGHLIGHT_STYLES[suffix-alias]="fg=white,underline"
        ZSH_HIGHLIGHT_STYLES[builtin]="fg=white"
        ZSH_HIGHLIGHT_STYLES[function]="fg=white"
        ZSH_HIGHLIGHT_STYLES[command]="fg=white"
        ZSH_HIGHLIGHT_STYLES[precommand]="fg=white,underline"
        ZSH_HIGHLIGHT_STYLES[hashed-command]="fg=white"
        for dir in \
            $HOME/.config/zsh/plugins/zsh-syntax-highlighting \
            /usr/share/zsh/plugins/zsh-syntax-highlighting \
            /usr/share/zsh-syntax-highlighting
        do
            [[ ! -d $dir ]] || . $dir/zsh-syntax-highlighting.zsh
            [[ ! -d $dir ]] || break
        done; unset dir

        # History substring search
        autoload up-line-or-beginning-search
        autoload down-line-or-beginning-search
        zle -N up-line-or-beginning-search
        zle -N down-line-or-beginning-search
        if [[ -n $MILESRC_VI_BINDINGS ]]; then
            bindkey -M vicmd "k" up-line-or-beginning-search
            bindkey -M vicmd "j" down-line-or-beginning-search
        fi

        for dir in \
            $HOME/.config/zsh/plugins/zsh-history-substring-search \
            /usr/share/zsh/plugins/zsh-history-substring-search
        do
            if [[ -d $dir ]]; then
                . $dir/zsh-history-substring-search.zsh
                if [[ -n $MILESRC_VI_BINDINGS ]]; then
                    bindkey -M vicmd "k" history-substring-search-up
                    bindkey -M vicmd "j" history-substring-search-down
                fi
                break
            fi
        done; unset dir

        HISTORY_SUBSTRING_SEARCH_HIGHLIGHT_FOUND="bg=007,fg=008"
        export HISTORY_SUBSTRING_SEARCH_HIGHLIGHT_FOUND
        # }}}
        ;;
esac

# {{{ Env Vars
# TERM
# Don't do this as it can break zsh highlighting
# export TERM="screen-256color"
# But this appears safe
export TERM="xterm-256color"
[[ -z $TMUX ]] || export TERM="tmux-256color"

# Java
export JAVA_HOME="$(
    find /usr/lib/jvm -maxdepth 1 \
    -iregex ".*java-[0-9]+-openjdk.*" -print -quit 2>/dev/null
)"

# Editor of choice
export EDITOR="vim"

# GPG
[[ -z $(installed tty) ]] || export GPG_TTY="$(tty)"

# Secure perms
# Don't touch umask EVER
# [[ -n $(id | grep -s "uid=0") ]] || umask 077
# Instead do something like:
# setfacl -m d:u::rwX,g::-,o::- -R $HOME

# Less
export PAGER="less"
export LESS="-ciMRs"
if [[ -f $HOME/.config/less/lessfilter ]]; then
    export LESSOPEN="|$HOME/.config/less/lessfilter %s"
fi

# Make less more friendly for non-text input files, see lesspipe(1)
if [[ -n $(installed lesspipe) ]]; then
    export LESSOPEN="| lesspipe %s"
    export LESSCLOSE="lesspipe %s %s"
fi

# Command args

## ack
export ACK_ARGS="--smart-case"
export ACK_COLOR_FILENAME="green"
export ACK_COLOR_LINENO="white"
export ACK_COLOR_MATCH="black on_white"

## ag
AG_ARGS="-S "
AG_ARGS+="--color-match=\"47;1;30\" "
AG_ARGS+="--color-line-number=\"0;37\" "
AG_ARGS+="--color-path=\"0;32\""
export AG_ARGS

## grep
if [[ -n $(grep --help 2>&1 | grep -is "color") ]]; then
    export GREP_CLR="--color=auto"
fi
GREP_ARGS="$GREP_CLR -Iis "
GREP_ARGS+="--exclude-dir=.bzr "
GREP_ARGS+="--exclude-dir=.git "
GREP_ARGS+="--exclude-dir=.git-crypt "
GREP_ARGS+="--exclude-dir=.svn"
export GREP_ARGS
GREP_COLORS="fn=1;32:ln=0;37:ms=47;1;30:mc=47;1;30:sl=:cx=:bn=:se="
export GREP_COLORS

## rg
RG_ARGS="-S "
RG_ARGS+="--colors \"line:fg:white\" "
RG_ARGS+="--colors \"match:bg:white\" "
RG_ARGS+="--colors \"match:fg:black\" "
RG_ARGS+="--colors \"path:fg:green\""
export RG_ARGS

# Ruby
export GEM_HOME="$HOME/.gem/ruby"
export GEM_PATH="$GEM_HOME/gems"
[[ -z $(installed ruby) ]] || mkdir -p $GEM_HOME/bin $GEM_HOME/gems
if [[ -d $HOME/.gem ]] && [[ ! -f $HOME/.gemrc ]]; then
    echo "gem: --no-user-install" >$HOME/.gemrc
fi

# Python
if [[ ! -f $HOME/.config/pip/pip.conf ]]; then
    mkdir -p $HOME/.config/pip
    echo "[install]" >$HOME/.config/pip/pip.conf
    echo "user = yes" >>$HOME/.config/pip/pip.conf
fi

# Go
export GOPATH="$HOME/.go"
export GOBIN="$GOPATH/bin"
[[ -z $(installed go) ]] || mkdir -p $GOBIN

# Perl
export PERL_LOCAL_LIB_ROOT="$HOME/.cpan/perl5"
export PERL5LIB="$PERL_LOCAL_LIB_ROOT/lib/perl5"
export PERL_MB_OPT="--install_base \"$PERL_LOCAL_LIB_ROOT\""
export PERL_MM_OPT="INSTALL_BASE=$PERL_LOCAL_LIB_ROOT"
[[ -z $(installed perl) ]] || mkdir -p $PERL_LOCAL_LIB_ROOT

# Fix USER if not defined
export USER="${USER:-$(id -nu)}"

# Display
if [[ -z $DISPLAY ]] &&
   [[ -d /tmp/.X11-unix ]] &&
   [[ -n $(ls /tmp/.X11-unix) ]]
then
    for x in /tmp/.X11-unix/X*; do
        export DISPLAY=":${x#/tmp/.X11-unix/X}" && break
    done; unset x
fi
# }}}

# {{{ PATH
# Find dirs that should be in PATH
unset PTH
for dir in \
    $HOME/bin \
    $GEM_HOME/bin \
    $HOME/.local/bin \
    $GOPATH \
    $GOPATH/bin \
    $PERL_LOCAL_LIB_ROOT/bin \
    /usr/local/bin \
    /usr/local/sbin \
    /usr/bin \
    /usr/sbin \
    /bin \
    /sbin \
    /usr/bin/core_perl \
    /usr/bin/vendor_perl \
    $HOME/Android/Sdk/platform-tools \
    $HOME/Android/Sdk/tools \
    $HOME/Android/Sdk/tools/bin \
    $HOME/Android/Ndk \
    $HOME/.rvm/bin
do
    [[ ! -d $dir ]] || PTH="${PTH:+$PTH:}$dir"
done; unset dir

# Find missing from PATH
while read -r dir; do
    [[ ! -d $dir ]] || PTH="${PTH:+$PTH:}$dir"
done < <(echo "${PATH//:/\n}" | grep -Psv "${PTH//:/|}"); unset dir

# Set PATH
[[ -z $PTH ]] || export PATH="$PTH"
unset PTH
# }}}

# {{{ Prompt
[[ ! -f $HOME/.milesrc.prompt ]] || . $HOME/.milesrc.prompt
# }}}

# {{{ Aliases
if [[ -n $(installed ack-grep) ]]; then
    alias ack="ack-grep $ACK_ARGS"
elif [[ -n $(installed ack) ]]; then
    alias ack="\ack $ACK_ARGS"
fi
[[ -z $(installed ag) ]] || alias ag="\ag $AG_ARGS"
# alias cd="mycd"
alias cp="\cp -i"
[[ -z $(installed egrep) ]] || alias egrep="\egrep $GREP_ARGS"
alias emacs="\emacs -nw"
alias envg="env | grep -P"
alias f="sudo"
[[ -z $(installed gdb) ]] || alias gdb="\gdb -q"
[[ -z $(installed grep) ]] || alias grep="\grep $GREP_ARGS"
[[ -z $(installed less) ]] || alias l="less"
[[ -n $(installed less) ]] || alias l="more"
alias la="ls -A"
alias lag="la | grep -P"
alias ll="ls -hl"
alias lla="ll -A"
alias llag="lla | grep -P"
alias llg="ll | grep -P"
alias locate="\locate -e --regex"
alias ls="\ls --color=auto -F"
alias lsg="ls | grep -P"
alias mv="\mv -i"
[[ -z $(installed mimeopen) ]] || alias open="mimeopen"
alias nocolor="sed -r \"s/\[[0-9;]*[AKm]//g\""
alias p="ps -o pid,user,%cpu,cmd --sort=-%cpu"
alias pip2="python2 -m pip"
alias pip3="python3 -m pip"
alias psf="p -e --forest"
alias psg="p -e | grep -sv \"grep\" | grep -P"
alias psme="p -u \$USER"
alias psmef="psme --forest"
alias q="exit"
alias r="reset"
[[ -z $(installed rg) ]] || alias rg="\rg $RG_ARGS"
case "$MILESRC_SHELL" in
    *"bash") alias srcmilesrc=". \$HOME/.bashrc" ;;
    *"zsh") alias srcmilesrc=". \$HOME/.zshrc" ;;
esac
if [[ -f /opt/sublime_text/sublime_text ]]; then
    alias sublime="/opt/sublime_text/sublime_text"
fi
[[ -z $(installed sudo) ]] || alias sume="sudo -Es"
if [[ -n $(installed htop) ]]; then
    alias t="htop -d 10"
    alias tu="htop -d 10 -u \$USER"
else
    alias t="top -d 10"
    alias tu="top -d 10 -u \$USER"
fi
[[ -z $(installed w3m) ]] || alias w3m="\w3m -cookie"
alias which="command -v"

# Typos
alias claer="clear"
alias clar="clear"
alias clea="clear"
alias clae="clear"
alias gimpe="gimp"
alias got="git"
alias vm="mv"
# }}}

# {{{ Functions
if [[ -d $HOME/.milesrc/shell/functions ]]; then
    while read -r func; do
        . $func
    done < <(find $HOME/.milesrc/shell/functions -type f); unset func
fi

function git_clone() {
    if [[ -n $(installed git) ]]; then
        git clone $1 $2
    else
        [[ -n $(installed curl) ]] || return 1
        [[ $# -gt 0 ]] || return 2

        local git_url
        local group_or_user
        local repo
        local tmp="${1%.git}"

        case "$tmp" in
            "git@"*)
                tmp="${tmp#git@}"
                git_url="${tmp%:*}"
                tmp="${tmp##*:}"
                group_or_user="${tmp%/*}"
                repo="${tmp##*/}"
                ;;
            "https://"*)
                tmp="${tmp#https://}"
                git_url="${tmp%%/*}"
                tmp="${tmp#*/}"
                group_or_user="${tmp%/*}"
                repo="${tmp##*/}"
                ;;
        esac

        local url="https://$git_url/$group_or_user/$repo"
        case "$git_url" in
            "github.com")
                curl -LO "$url/archive/master.zip"
                [[ $? -eq 0 ]] || return 3
                unzip master.zip >/dev/null && rm -f master.zip
                [[ $? -eq 0 ]] || return 4
                if [[ $# -eq 1 ]]; then
                    mv $repo-master $repo
                else
                    mv $repo-master $2
                fi
                ;;
            "gitlab.com")
                curl -LO "$url/repository/master/archive.tar"
                [[ $? -eq 0 ]] || return 3
                tar -xf archive.tar && rm -f archive.tar
                [[ $? -eq 0 ]] || return 4
                if [[ $# -eq 1 ]]; then
                    mv $repo-master-* $repo
                else
                    mv $repo-master-* $2
                fi
                ;;
        esac
    fi
}

function ipa() {
    if [[ -n $(installed ip) ]]; then
        if ip 2>&1 | grep -Pq "c.olor"; then
            ip -c -o $@ a | grep -sv "mtu" | awk '{print $2,$4}'
        else
            ip -o $@ a | grep -sv "mtu" | awk '{print $2,$4}'
        fi
    else
        local device
        local inet
        while read -r line; do
            case "$line" in
                *encap*|*flags*)
                    device="$(echo "$line" | awk '{print $1}')"
                    ;;
                *inet6*addr:*)
                    inet="$(echo "$line" | awk '{print $3}')"
                    ;;
                *inet*) inet="$(echo "$line" | awk '{print $2}')"
                    ;;
                *) unset inet
                    ;;
            esac
            [[ -z $inet ]] || echo "$device $inet" | sed "s/addr://"
        done < <(ifconfig)
    fi
}

function ipr() {
    if [[ -n $(installed ip) ]]; then
        if ip 2>&1 | grep -Pq "c.olor"; then
            ip -c -o $@ r
        else
            ip -o $@ r
        fi
    else
        (
            echo "Route Gateway Interface"
            echo "----- ------- ---------"
            netstat -nr | awk '!/Routing|Internet|Destination/ {
                if (NF == 4) {
                    print $1,$2,$4
                } else if (NF == 7) {
                    print $1,$2,$6
                }
            }'
        ) | column -t
    fi
}

function iso2usb() {
    local usage="Usage: iso2usb [-h|--help] <iso> <dev>"

    [[ $# -ne 2 ]] && echo $usage && return 1
    [[ ! -f $1 ]] && echo $usage && return 2
    [[ ! -b $2 ]] && echo $usage && return 3

    sudo dd if="$1" of="$2" bs="4M"
}

function milesrc() {
    echo "Configuration via files"
    echo
    echo "    ~/.git.nostatus"
    echo "        Prompt will not show any git status for paths in"
    echo "        this file. One path per line."
    echo "    ~/.milesrc.local"
    echo "        Sourced last. Put your custom bash/zsh settings"
    echo "        here."
    echo "    ~/.milesrc.pre"
    echo "        Sourced first. Put specified ENV vars here (see"
    echo "        below)"
    echo
    echo "Configuration via ENV vars (put in ~/.milesrc.local unless"
    echo "otherwise specified)"
    echo
    case "$(uname -s)" in
        "Darwin")
            echo "    MILESRC_ACKNOWLEDGE_MACOS_IS_DUMB"
            echo -n "        If set, hide warnings about missing gnu "
            echo "utilities"
            echo "        on macOS."
        ;;
    esac
    echo "    MILESRC_LS_AFTER_CD"
    echo "        If set, and you alias cd to mycd, ls will be"
    echo "        automatically run after each cd. You likely don't"
    echo "        want this if you're looking at large directory"
    echo "        trees with numerous files in each directory."
    echo "    MILESRC_PROMPT"
    echo "        Should be an array, and, if set, will theme the"
    echo "        prompt. Unsetting should immediately untheme the"
    echo "        prompt. Example below:"
    echo "            delcare -a MILESRC_PROMPT"
    echo "            MILESRC_PROMPT=("
    echo "                \"host;white;blue;root;white;160\""
    echo "                \"venv;white;166\""
    echo "                \"git;light_black;white\""
    echo "                \"cwd;white;light_black\""
    echo "                \"vi_ins;white;green;vi_cmd;white;blue\""
    echo "                \"newline\""
    echo "                \"exit;white;red\""
    echo "                \"prompt;white;light_black\""
    echo "            )"
    echo "            export MILESRC_PROMPT"
    echo "        These are generally of the form:"
    echo "            section;fg_color;bg_color"
    echo "        where section is one of:"
    echo "            cwd, exit, git, host, newline, prompt, venv,"
    echo "            or vi_ins|vi_cmd"
    echo "        and valid colors are:"
    echo "            black, red, green, yellow, blue, magenta, cyan,"
    echo "            white, light_black, light_red, light_green,"
    echo "            light_yellow, light_blue, light_magenta,"
    echo "            light_cyan, light_white, or any number in 0-255"
    echo "    MILESRC_SSH_AGENT"
    echo "        If set (in ~/.milesrc.pre), start an ssh-agent."
    echo "    MILESRC_TMUX"
    echo "        If set (in ~/.milesrc.pre), attach to tmux session."
    echo "    MILESRC_VI_BINDINGS"
    echo "        If set (in ~/.milesrc.pre), use vi keybindings."
}

function mycd() {
    local ls_args="--color=auto -F"
    if [[ $# -eq 0 ]] || [[ -d "$@" ]] || [[ $@ == "-" ]]; then
        \cd "$@" >/dev/null
        if [[ $? -eq 0 ]] && [[ -n $MILESRC_LS_AFTER_CD ]]; then
            ls $ls_args
        fi
    elif [[ -d $(echo "$PWD/$@" | sed -r "s|[^/]+/\.\.||g") ]]; then
        \cd "$@" >/dev/null
        if [[ $? -eq 0 ]] && [[ -n $MILESRC_LS_AFTER_CD ]]; then
            ls $ls_args
        fi
    else
        echo "Directory doesn't exist: $@"
        local in="$(dirname "$@")"
        local seek="$(basename "$@")"
        local possible="$(
            find -L $in -maxdepth 1 -type d -iname "$seek*" \
            2>/dev/null | sort | head -n 1
        )"
        if [[ -n $possible ]] && [[ -d "$possible" ]]; then
            echo "Guessing you meant: $possible"
            echo
            \cd $possible >/dev/null
            if [[ $? -eq 0 ]] && [[ -n $MILESRC_LS_AFTER_CD ]]; then
                ls $ls_args
            fi
        fi
    fi
    return 0
}

function os() {
    cat /etc/os-release | sed -r -e "s/^NAME=\"?|\"?$//g" \
        -e "/^[^=]+$/p" -n
}

function remove_spaces_in_names() {
    local dir
    for dir in "$@"; do
        if [[ ! -d $dir ]]; then
            echo "$dir does not exist"
            return
        fi
    done

    local look_in="."
    [[ $# -eq 0 ]] || look_in="$@"

    # Determine rename command
    local rnm="$(installed rename)"
    if [[ -e /usr/bin/site_perl/rename ]]; then
        rnm="/usr/bin/site_perl/rename"
    fi

    # May need to cpan install File::Rename
    if [[ -z $rnm ]] || [[ -z $($rnm -h | grep -s "perl") ]]; then
        echo "Please run \"sudo cpan File::Rename\""
        return
    fi

    find $look_in -depth -name "* *" -execdir $rnm -v "s/ /_/g" "{}" +
}

case "$MILESRC_SHELL" in
    *"bash")
        function reset_completions() {
            [[ -d $HOME/.config/bash/complete ]] || return
            while read -r comp; do
                . $HOME/.config/bash/complete/$comp
            done < <(find $HOME/.config/bash/complete -type f)
            unset comp
        }
        ;;
    *"zsh")
        function reset_completions() {
            local comps=($HOME/.config/zsh/complete/_*)
            unfunction $comps:t 2>/dev/null
            autoload -U $comps:t
        }
        ;;
esac

function simplehttp() {
    case "$1" in
        "busybox")
            if [[ -n $(installed busybox) ]]; then
                busybox httpd -f -p ${2:-8080}
            else
                echo "busybox is not installed"
            fi
            ;;
        "perl")
            if [[ -n $(installed plackup) ]]; then
                plackup -MPlack::App::Directory \
                    -e 'Plack::App::Directory->new(root=>".");' \
                    -p ${2:-8080}
            else
                echo "Please run: cpan Plack"
            fi
            ;;
        "php")
            if [[ -n $(installed php) ]]; then
                php -S 127.0.0.1:${2:-8080}
            else
                echo "php is not installed"
            fi
            ;;
        "python2")
            if [[ -n $(installed python2) ]]; then
                python2 -m SimpleHTTPServer ${2:-8080}
            else
                echo "python2 is not installed"
            fi
            ;;
        "python3")
            if [[ -n $(installed python3) ]]; then
                python3 -m http.server ${2:-8080}
            else
                echo "python3 is not installed"
            fi
            ;;
        "ruby")
            if [[ -n $(installed ruby) ]]; then
                ruby -r un -e httpd . -p ${2:-8080}
            else
                echo "ruby is not installed"
            fi
            ;;
        "twisted")
            if [[ -n $(installed twistd) ]]; then
                twistd -n web -p ${2:-8080} --path .
            else
                echo "Please run: python2 -m pip install twisted"
            fi
            ;;
        *)
            echo "Usage: simplehttp <lang> [port]"
            echo
            echo "Port defaults to 8080."
            echo
            echo "Languages:"
            [[ -z $(installed busybox) ]] || echo "    busybox"
            [[ -z $(installed perl) ]] || echo "    perl"
            [[ -z $(installed php) ]] || echo "    php"
            [[ -z $(installed python2) ]] || echo "    python2"
            [[ -z $(installed python3) ]] || echo "    python3"
            [[ -z $(installed ruby) ]] || echo "    ruby"
            [[ -z $(installed python2) ]] || echo "    twisted"
            ;;
    esac
}

function tdump() {
    if [[ -z $(installed tcpdump) ]]; then
        echo "tcpdump is not installed"
        return
    fi

    local cap="$(echo "$@" | grep -oPs "\S+\.pcap")"
    sudo tcpdump -n -vvv $@
    [[ -z $(id | grep -s "uid=0") ]] || return 0
    local name="$(id -nu)"
    local group="$(id -gn)"
    [[ -z $cap ]] || [[ ! -f $cap ]] || sudo chown $name:$group $cap
}

function update_grub() {
    for mkconfig in \
        grub-mkconfig \
        grub2-mkconfig
    do
        [[ -n $(command -v $mkconfig) ]] || continue
        for cfg in \
            /boot/grub \
            /boot/grub2
        do
            [[ -d $cfg ]] || continue
            sudo $mkconfig -o $cfg/grub.cfg
        done
    done
}

function x() {
    case "$1" in
        *.tar*|*.tgz)
            if [[ -z $(installed tar) ]]; then
                echo "tar is not installed"
            else
                tar -xf $@
            fi
            ;;
        *.7z)
            if [[ -z $(installed 7z) ]]; then
                echo "p7zip is not installed"
            else
                7z x $@
            fi
            ;;
        *.bz2)
            if [[ -z $(installed bzip2) ]]; then
                echo "bzip2 is not installed"
            else
                bzip2 -dk $@
            fi
            ;;
        *.gz)
            if [[ -z $(installed gzip) ]]; then
                echo "gzip is not installed"
            else
                gzip -dk $@
            fi
            ;;
        *.jar)
            if [[ -z $(installed jar) ]]; then
                echo "java is not installed"
            else
                jar -xf $@
            fi
            ;;
        *.rar)
            if [[ -z $(installed unrar) ]]; then
                echo "unrar is not installed"
            else
                unrar x $@
            fi
            ;;
        *.rpm)
            if [[ -z $(installed rpm2cpio) ]]; then
                echo "rpm2cpio is not installed"
            elif [[ -z $(installed cpio) ]]; then
                echo "rpm2cpio is not installed"
            else
                rpm2cpio $@ | cpio -idmv
            fi
            ;;
        *.xz)
            if [[ -z $(installed xz) ]]; then
                echo "xz is not installed"
            else
                xz -dk $@
            fi
            ;;
        *.zip)
            if [[ -z $(installed unzip) ]]; then
                echo "unzip is not installed"
            else
                unzip $@
            fi
            ;;
        *)
            if [[ -n $(installed aunpack) ]]; then
                aunpack $@
            else
                echo "Unknown archive format!"
            fi
            ;;
    esac
}
# }}}

case "$MILESRC_SHELL" in
    *"bash")
        # {{{ Bash completions
        if [[ -d $HOME/.config/bash/complete ]]; then
            while read -r comp; do
                . $HOME/.config/bash/complete/$comp
            done < <(find $HOME/.config/bash/complete -type f)
            unset comp
        fi

        # Complete gimme function
        if [[ -n $(installed apt-get) ]]; then
            function _apt_install_complete() {
                mapfile -t COMPREPLY < <(
                    apt-cache --no-generate pkgnames "$2"
                )
            }
            complete -F _apt_install_complete gimme
        elif [[ -n $(installed pacman) ]]; then
            if [[ -n $(installed ruaur) ]]; then
                function _ruaur_install_complete() {
                    mapfile -t COMPREPLY < <(
                        ruaur -Ss "$2" --names-only | \
                        grep -Ps "^$2" | sort -u
                    )
                }
                complete -F _ruaur_install_complete gimme
            else
                function _pacman_install_complete() {
                    mapfile -t COMPREPLY < <(
                        pacman --color=never -Ss "$2" | \
                        grep -oPs "^[^/]+/\K$2\S*" | sort -u
                    )
                }
                complete -F _pacman_install_complete gimme
            fi
        elif [[ -n $(installed brew) ]]; then
            function _brew_install_complete() {
                mapfile -t COMPREPLY < <(brew search "$2")
            }
            complete -F _brew_install_complete gimme
        elif [[ -n $(installed crew) ]]; then
            function _crew_install_complete() {
                mapfile -t COMPREPLY < <(
                    crew search "$2" | awk '{print $1}'
                )
            }
            complete -F _crew_install_complete gimme
        fi
        # }}}
        ;;
    *"zsh")
        # {{{ Zsh completions
        if [[ -d $HOME/.config/zsh/complete ]]; then
            fpath=($HOME/.config/zsh/complete $fpath)
        fi

        for dir in \
            $HOME/.config/zsh/plugins/zsh-completions/src \
            /usr/share/zsh/plugins/zsh-completions/src \
            /usr/share/zsh/site-functions
        do
            [[ ! -d $dir ]] || fpath=($dir $fpath)
        done; unset dir

        if [[ $ZSHV -gt 4.2 ]]; then
            if [[ -z $(command -v compdef) ]]; then
                autoload -Uz compinit && compinit -u
            fi
        fi

        # Complete gimme function
        if [[ -n $(installed apt-get) ]]; then
            function _apt_install_complete() {
                reply=($(apt-cache --no-generate pkgnames "$1"))
            }
            compctl -K _apt_install_complete gimme
        elif [[ -n $(installed pacman) ]]; then
            if [[ -n $(installed ruaur) ]]; then
                compdef _gnu_generic ruaur
                function _ruaur_install_complete() {
                    reply=($(ruaur -Ss "$1" --names-only))
                }
                compctl -K _ruaur_install_complete gimme
            else
                function _pacman_install_complete() {
                    reply=($(
                        pacman --color=never -Ss "$1" | \
                        grep -oPs "^[^/]+/\K^\S*"
                    ))
                }
                compctl -K _pacman_install_complete gimme
            fi
        elif [[ -n $(installed brew) ]]; then
            function _brew_install_complete() {
                reply=($(brew search "$1"))
            }
            compctl -K _brew_install_complete gimme
        elif [[ -n $(installed crew) ]]; then
            function _crew_install_complete() {
                reply=($(crew search "$1" | awk '{print $1}'))
            }
            compctl -K _crew_install_complete gimme
        fi
        # }}}
        ;;
esac

# {{{ Wrap-up
# Xterm
if [[ -n $(installed xrdb) ]] && [[ -f $HOME/.Xresources ]]; then
    xrdb -merge $HOME/.Xresources 2>/dev/null
fi

# Local stuff
[[ ! -f $HOME/.milesrc.local ]] || . $HOME/.milesrc.local
# }}}
